<% const currentPage = 'reports-history'; const pageTitle = 'Storico Rapporti'; %>

<div class="card">
  <div class="card-header">
    <div>
      <h2 class="card-title">I Miei Rapporti</h2>
      <p class="card-subtitle">Storico completo dei tuoi viaggi</p>
    </div>
  </div>

  <form method="GET" action="/rider/reports-history" class="mb-4">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      <div class="form-group mb-0">
        <label class="form-label">Dal</label>
        <input type="date" name="start_date" class="form-input" value="<%= filters.start_date || '' %>">
      </div>

      <div class="form-group mb-0">
        <label class="form-label">Al</label>
        <input type="date" name="end_date" class="form-input" value="<%= filters.end_date || '' %>">
      </div>

      <div class="form-group mb-0">
        <label class="form-label">Veicolo</label>
        <select name="vehicle_id" class="form-select">
          <option value="">Tutti</option>
          <% vehicles.forEach(v => { %>
            <option value="<%= v.id %>" <%= filters.vehicle_id == v.id ? 'selected' : '' %>>
              <%= v.targa %> - <%= v.modello %>
            </option>
          <% }) %>
        </select>
      </div>

      <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter"></i> Filtra
        </button>
        <a href="/rider/reports-history" class="btn btn-secondary">Reset</a>
      </div>
    </div>
  </form>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>Data</th>
          <th>Veicolo</th>
          <th>Orari</th>
          <th>Km</th>
          <th>Pacchi</th>
          <th>Carburante</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        <% if (reports.length === 0) { %>
          <tr><td colspan="7" class="text-center text-secondary">Nessun rapporto trovato</td></tr>
        <% } else { %>
          <% reports.forEach(report => { %>
            <tr>
              <td><%= new Date(report.data).toLocaleDateString('it-IT') %></td>
              <td>
                <strong><%= report.targa %></strong><br>
                <small class="text-secondary"><%= report.modello %></small>
              </td>
              <td>
                <div style="font-size: 0.9rem;">
                  <div><strong>P:</strong> <%= report.ora_partenza ? new Date(report.ora_partenza).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) : '-' %></div>
                  <% if (report.ora_ritorno) { %>
                    <div><strong>R:</strong> <%= new Date(report.ora_ritorno).toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' }) %></div>
                  <% } %>
                </div>
              </td>
              <td>
                <div style="font-size: 0.9rem;">
                  <div><strong>P:</strong> <%= report.km_partenza %></div>
                  <% if (report.km_arrivo) { %>
                    <div><strong>R:</strong> <%= report.km_arrivo %></div>
                    <div class="text-primary"><strong>Î”:</strong> <%= report.km_arrivo - report.km_partenza %> km</div>
                  <% } %>
                </div>
              </td>
              <td>
                <div style="font-size: 0.9rem;">
                  <div><strong>Rit:</strong> <%= report.pacchi_ritirati || 0 %></div>
                  <% if (report.pacchi_consegnati) { %>
                    <div><strong>Cons:</strong> <%= report.pacchi_consegnati %></div>
                  <% } %>
                </div>
              </td>
              <td>
                <% if (report.tipo_carburante === 'ip') { %>
                  <span class="badge badge-primary">IP</span>
                <% } else if (report.tipo_carburante === 'dkv') { %>
                  <span class="badge badge-secondary">DKV</span>
                  <% if (report.numero_carta_dkv) { %>
                    <br><small><%= report.numero_carta_dkv %></small>
                  <% } %>
                <% } %>
              </td>
              <td>
                <a href="/rider/report/<%= report.id %>" class="btn-icon" title="Dettagli">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <% if (reports.length > 0) { %>
    <div class="mt-4 text-center text-secondary">
      Totale rapporti: <%= reports.length %>
    </div>
  <% } %>
</div>
