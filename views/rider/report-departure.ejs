<% const currentPage = 'new-report'; const pageTitle = 'Nuovo Rapporto - Partenza'; %>

<div class="card" style="max-width: 1000px; margin: 0 auto;">
  <div class="card-header">
    <h2 class="card-title">Rapporto di Partenza</h2>
    <p class="card-subtitle">Compila i dati prima della partenza</p>
  </div>

  <div class="mb-4" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
    <h3 class="font-bold mb-2">Veicolo Assegnato</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      <div><strong>Targa:</strong> <%= assignment.targa %></div>
      <div><strong>Modello:</strong> <%= assignment.modello %></div>
      <div><strong>Km Attuali:</strong> <%= assignment.km_attuali.toLocaleString('it-IT') %> km</div>
    </div>
  </div>

  <form action="/rider/reports/departure" method="POST" enctype="multipart/form-data">
    <input type="hidden" name="vehicle_id" value="<%= assignment.vehicle_id %>">
    <input type="hidden" name="firma_partenza" id="firma_partenza">

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Codice Giro *</label>
        <input type="text" name="codice_giro" class="form-input" placeholder="es. A12" value="<%= (typeof formData !== 'undefined' && formData.codice_giro) ? formData.codice_giro : '' %>" required>
      </div>

      <div class="form-group">
        <label class="form-label">Ora Partenza *</label>
        <input type="time" name="ora_partenza" class="form-input" value="<%= (typeof formData !== 'undefined' && formData.ora_partenza) ? formData.ora_partenza : '' %>" required>
      </div>

      <div class="form-group">
        <label class="form-label">Km Partenza *</label>
        <input type="number" name="km_partenza" class="form-input" required placeholder="Inserisci km partenza" value="<%= (typeof formData !== 'undefined' && formData.km_partenza) ? formData.km_partenza : '' %>">
        <p class="form-help">Inserisci i chilometri dal cruscotto</p>
      </div>

      <div class="form-group">
        <label class="form-label">Numero Ditta</label>
        <input type="text" name="numero_ditta" class="form-input" value="<%= (typeof formData !== 'undefined' && formData.numero_ditta) ? formData.numero_ditta : '' %>">
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Pacchi Ritirati</label>
        <input type="number" name="pacchi_ritirati" class="form-input" value="<%= (typeof formData !== 'undefined' && formData.pacchi_ritirati) ? formData.pacchi_ritirati : 0 %>" min="0">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Firma Digitale *</label>
      <div class="signature-container">
        <canvas id="signatureCanvas"></canvas>
        <button type="button" onclick="signaturePad.clear()" class="btn btn-outline mt-2">
          <i class="fas fa-eraser"></i> Cancella Firma
        </button>
      </div>
    </div>

    <h3 class="font-bold mb-3 mt-4">Foto Veicolo (5 foto richieste) *</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Foto Frontale</label>
        <input type="file" name="foto_frontale" class="form-input" accept="image/*" capture="environment" required data-preview="previewFrontale">
        <img id="previewFrontale" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Posteriore</label>
        <input type="file" name="foto_posteriore" class="form-input" accept="image/*" capture="environment" required data-preview="previewPosteriore">
        <img id="previewPosteriore" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Lato Destro</label>
        <input type="file" name="foto_destra" class="form-input" accept="image/*" capture="environment" required data-preview="previewDestra">
        <img id="previewDestra" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Lato Sinistro</label>
        <input type="file" name="foto_sinistra" class="form-input" accept="image/*" capture="environment" required data-preview="previewSinistra">
        <img id="previewSinistra" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Cruscotto</label>
        <input type="file" name="foto_cruscotto" class="form-input" accept="image/*" capture="environment" required data-preview="previewCruscotto">
        <img id="previewCruscotto" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>
    </div>

    <div class="flex gap-2 mt-4">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i> Registra Partenza
      </button>
      <a href="/rider/dashboard" class="btn btn-outline">
        <i class="fas fa-times"></i> Annulla
      </a>
    </div>
  </form>
</div>

<script>
const signaturePad = new RobiFleet.SignaturePad('signatureCanvas');

// Funzione per comprimere immagini aggressivamente per Vercel (limite 4.5MB totale)
async function compressImage(file, maxWidth = 1200, quality = 0.6) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Ridimensiona aggressivamente per mobile
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => {
          // Se ancora troppo grande, ricomprimi con qualit√† inferiore
          if (blob.size > 700000) { // 700KB
            canvas.toBlob((blob2) => {
              resolve(new File([blob2], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              }));
            }, 'image/jpeg', 0.4);
          } else {
            resolve(new File([blob], file.name, {
              type: 'image/jpeg',
              lastModified: Date.now()
            }));
          }
        }, 'image/jpeg', quality);
      };
    };
  });
}

// Comprimi immagini quando vengono selezionate
document.querySelectorAll('input[type="file"]').forEach(input => {
  input.addEventListener('change', async function(e) {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      console.log(`üì∏ File originale: ${(file.size / 1024).toFixed(0)}KB`);
      
      // Comprimi l'immagine
      const compressed = await compressImage(file);
      console.log(`üì∏ File compresso: ${(compressed.size / 1024).toFixed(0)}KB`);
      
      // Sostituisci il file nell'input
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(compressed);
      this.files = dataTransfer.files;
      
      // Mostra anteprima
      const previewId = this.getAttribute('data-preview');
      if (previewId) {
        const preview = document.getElementById(previewId);
        preview.src = URL.createObjectURL(compressed);
        preview.style.display = 'block';
      }
    }
  });
});

document.querySelector('form').addEventListener('submit', function(e) {
  const sigData = signaturePad.getDataURL();
  if (!sigData || sigData === 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==') {
    e.preventDefault();
    alert('Inserisci la firma prima di continuare');
    return;
  }
  document.getElementById('firma_partenza').value = sigData;
  
  // Calcola dimensione totale payload
  const formData = new FormData(this);
  let totalSize = 0;
  for (let [key, value] of formData.entries()) {
    if (value instanceof File) {
      totalSize += value.size;
    }
  }
  totalSize += sigData.length;
  
  console.log(`üì¶ Dimensione totale payload: ${(totalSize / 1024 / 1024).toFixed(2)}MB`);
  
  if (totalSize > 4000000) { // 4MB (sotto il limite Vercel di 4.5MB)
    e.preventDefault();
    alert('‚ö†Ô∏è Foto troppo grandi. Limite: 4MB totali. Dimensione attuale: ' + (totalSize / 1024 / 1024).toFixed(2) + 'MB. Riprova con foto pi√π piccole.');
    return;
  }
  
  // Mostra loader durante invio
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Invio in corso...';
});
</script>
