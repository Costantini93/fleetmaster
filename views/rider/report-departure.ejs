<% const currentPage = 'new-report'; const pageTitle = 'Nuovo Rapporto - Partenza'; %>

<div class="card" style="max-width: 1000px; margin: 0 auto;">
  <div class="card-header">
    <h2 class="card-title">Rapporto di Partenza</h2>
    <p class="card-subtitle">Compila i dati prima della partenza</p>
  </div>

  <div class="mb-4" style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
    <h3 class="font-bold mb-2">Veicolo Assegnato</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      <div><strong>Targa:</strong> <%= assignment.targa %></div>
      <div><strong>Modello:</strong> <%= assignment.modello %></div>
      <div><strong>Km Attuali:</strong> <%= assignment.km_attuali.toLocaleString('it-IT') %> km</div>
    </div>
  </div>

  <form id="departureForm">
    <input type="hidden" name="vehicle_id" value="<%= assignment.vehicle_id %>">
    <input type="hidden" name="firma_partenza" id="firma_partenza">
    <input type="hidden" id="foto_frontale_base64">
    <input type="hidden" id="foto_posteriore_base64">
    <input type="hidden" id="foto_destra_base64">
    <input type="hidden" id="foto_sinistra_base64">
    <input type="hidden" id="foto_cruscotto_base64">

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Codice Giro *</label>
        <input type="text" name="codice_giro" class="form-input" placeholder="es. A12" value="<%= (typeof formData !== 'undefined' && formData.codice_giro) ? formData.codice_giro : '' %>" required>
      </div>

      <div class="form-group">
        <label class="form-label">Ora Partenza *</label>
        <input type="time" name="ora_partenza" class="form-input" value="<%= (typeof formData !== 'undefined' && formData.ora_partenza) ? formData.ora_partenza : '' %>" required>
      </div>

      <div class="form-group">
        <label class="form-label">Km Partenza *</label>
        <input type="number" name="km_partenza" class="form-input" required placeholder="Inserisci km partenza" value="<%= (typeof formData !== 'undefined' && formData.km_partenza) ? formData.km_partenza : '' %>">
        <p class="form-help">Inserisci i chilometri dal cruscotto</p>
      </div>

      <div class="form-group">
        <label class="form-label">Numero Ditta</label>
        <input type="text" name="numero_ditta" class="form-input" value="<%= (typeof formData !== 'undefined' && formData.numero_ditta) ? formData.numero_ditta : '' %>">
      </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Pacchi Ritirati</label>
        <input type="number" name="pacchi_ritirati" class="form-input" value="<%= (typeof formData !== 'undefined' && formData.pacchi_ritirati) ? formData.pacchi_ritirati : 0 %>" min="0">
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Firma Digitale *</label>
      <div class="signature-container">
        <canvas id="signatureCanvas"></canvas>
        <button type="button" onclick="signaturePad.clear()" class="btn btn-outline mt-2">
          <i class="fas fa-eraser"></i> Cancella Firma
        </button>
      </div>
    </div>

    <h3 class="font-bold mb-3 mt-4">Foto Veicolo (5 foto richieste) *</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
      <div class="form-group">
        <label class="form-label">Foto Frontale</label>
        <input type="file" name="foto_frontale" class="form-input" accept="image/*" capture="environment" required data-preview="previewFrontale">
        <img id="previewFrontale" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Posteriore</label>
        <input type="file" name="foto_posteriore" class="form-input" accept="image/*" capture="environment" required data-preview="previewPosteriore">
        <img id="previewPosteriore" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Lato Destro</label>
        <input type="file" name="foto_destra" class="form-input" accept="image/*" capture="environment" required data-preview="previewDestra">
        <img id="previewDestra" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Lato Sinistro</label>
        <input type="file" name="foto_sinistra" class="form-input" accept="image/*" capture="environment" required data-preview="previewSinistra">
        <img id="previewSinistra" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>

      <div class="form-group">
        <label class="form-label">Foto Cruscotto</label>
        <input type="file" name="foto_cruscotto" class="form-input" accept="image/*" capture="environment" required data-preview="previewCruscotto">
        <img id="previewCruscotto" style="display:none; width:100%; margin-top:0.5rem; border-radius:8px;">
      </div>
    </div>

    <div class="flex gap-2 mt-4">
      <button type="submit" class="btn btn-primary">
        <i class="fas fa-paper-plane"></i> Registra Partenza
      </button>
      <a href="/rider/dashboard" class="btn btn-outline">
        <i class="fas fa-times"></i> Annulla
      </a>
    </div>
  </form>
</div>

<script>
const signaturePad = new RobiFleet.SignaturePad('signatureCanvas');

// Funzione per comprimere immagini MOLTO aggressivamente per Vercel (limite 4.5MB totale)
async function compressImage(file, maxWidth = 800, quality = 0.5) {
  return new Promise((resolve) => {
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = (e) => {
      const img = new Image();
      img.src = e.target.result;
      img.onload = () => {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Ridimensiona MOLTO aggressivamente per mobile (max 800px)
        if (width > maxWidth) {
          height = Math.round((height * maxWidth) / width);
          width = maxWidth;
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        canvas.toBlob((blob) => {
          // Se ancora troppo grande, ricomprimi con qualit√† inferiore
          if (blob.size > 300000) { // 300KB target per foto
            canvas.toBlob((blob2) => {
              resolve(new File([blob2], file.name, {
                type: 'image/jpeg',
                lastModified: Date.now()
              }));
            }, 'image/jpeg', 0.3);
          } else {
            resolve(new File([blob], file.name, {
              type: 'image/jpeg',
              lastModified: Date.now()
            }));
          }
        }, 'image/jpeg', quality);
      };
    };
  });
}

// Comprimi immagini quando vengono selezionate e salva in base64
document.querySelectorAll('input[type="file"]').forEach(input => {
  input.addEventListener('change', async function(e) {
    if (this.files && this.files[0]) {
      const file = this.files[0];
      console.log(`üì∏ File originale: ${(file.size / 1024).toFixed(0)}KB`);
      
      // Comprimi l'immagine
      const compressed = await compressImage(file);
      console.log(`üì∏ File compresso: ${(compressed.size / 1024).toFixed(0)}KB`);
      
      // Converti in base64
      const reader = new FileReader();
      reader.readAsDataURL(compressed);
      reader.onload = () => {
        const base64 = reader.result.split(',')[1]; // Rimuovi il prefisso data:image/jpeg;base64,
        const fieldName = this.name;
        document.getElementById(fieldName + '_base64').value = base64;
        console.log(`‚úÖ ${fieldName}: ${(base64.length / 1024).toFixed(0)}KB salvato`);
      };
      
      // Mostra anteprima
      const previewId = this.getAttribute('data-preview');
      if (previewId) {
        const preview = document.getElementById(previewId);
        preview.src = URL.createObjectURL(compressed);
        preview.style.display = 'block';
      }
    }
  });
});

document.querySelector('#departureForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const sigData = signaturePad.getDataURL();
  if (!sigData || sigData === 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg==') {
    alert('Inserisci la firma prima di continuare');
    return;
  }
  
  // Verifica che tutte le foto siano state caricate
  const fotoFields = ['foto_frontale', 'foto_posteriore', 'foto_destra', 'foto_sinistra', 'foto_cruscotto'];
  for (const field of fotoFields) {
    if (!document.getElementById(field + '_base64').value) {
      alert(`Carica la foto: ${field.replace('foto_', '').replace('_', ' ')}`);
      return;
    }
  }
  
  // Prepara i dati
  const formData = {
    vehicle_id: document.querySelector('[name="vehicle_id"]').value,
    codice_giro: document.querySelector('[name="codice_giro"]').value,
    ora_partenza: document.querySelector('[name="ora_partenza"]').value,
    km_partenza: document.querySelector('[name="km_partenza"]').value,
    numero_ditta: document.querySelector('[name="numero_ditta"]').value,
    pacchi_ritirati: document.querySelector('[name="pacchi_ritirati"]').value,
    firma_partenza: sigData.split(',')[1], // Solo la parte base64
    foto_frontale: document.getElementById('foto_frontale_base64').value,
    foto_posteriore: document.getElementById('foto_posteriore_base64').value,
    foto_destra: document.getElementById('foto_destra_base64').value,
    foto_sinistra: document.getElementById('foto_sinistra_base64').value,
    foto_cruscotto: document.getElementById('foto_cruscotto_base64').value
  };
  
  // Calcola dimensione totale
  const totalSize = JSON.stringify(formData).length;
  console.log(`üì¶ Dimensione totale JSON: ${(totalSize / 1024 / 1024).toFixed(2)}MB`);
  
  if (totalSize > 3000000) {
    alert('‚ö†Ô∏è Foto troppo grandi. Dimensione: ' + (totalSize / 1024 / 1024).toFixed(2) + 'MB. Riprova.');
    return;
  }
  
  // Mostra loader
  const submitBtn = this.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Invio in corso...';
  
  try {
    const response = await fetch('/rider/reports/departure', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    });
    
    if (response.ok) {
      window.location.href = '/rider/dashboard';
    } else {
      const error = await response.text();
      alert('Errore: ' + error);
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Registra Partenza';
    }
  } catch (error) {
    console.error('Errore:', error);
    alert('Errore durante l\'invio: ' + error.message);
    submitBtn.disabled = false;
    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Registra Partenza';
  }
});
</script>
