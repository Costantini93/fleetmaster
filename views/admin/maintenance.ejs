<% const currentPage = 'maintenance'; const pageTitle = 'Gestione Manutenzioni'; %>

<div class="card">
  <div class="card-header">
    <div>
      <h2 class="card-title">Richieste di Manutenzione</h2>
      <p class="card-subtitle">Gestisci tutte le richieste di manutenzione</p>
    </div>
  </div>

  <!-- Filtri -->
  <form method="GET" class="mb-3">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
      <div class="form-group mb-0">
        <label class="form-label">Stato</label>
        <select name="status" class="form-select">
          <option value="all" <%= filters.status === 'all' ? 'selected' : '' %>>Tutti</option>
          <option value="in_attesa" <%= filters.status === 'in_attesa' ? 'selected' : '' %>>In Attesa</option>
          <option value="in_lavorazione" <%= filters.status === 'in_lavorazione' ? 'selected' : '' %>>In Lavorazione</option>
          <option value="completata" <%= filters.status === 'completata' ? 'selected' : '' %>>Completata</option>
        </select>
      </div>
      <div class="form-group mb-0">
        <label class="form-label">Priorità</label>
        <select name="priority" class="form-select">
          <option value="all" <%= filters.priority === 'all' ? 'selected' : '' %>>Tutte</option>
          <option value="critica" <%= filters.priority === 'critica' ? 'selected' : '' %>>Critica</option>
          <option value="alta" <%= filters.priority === 'alta' ? 'selected' : '' %>>Alta</option>
          <option value="media" <%= filters.priority === 'media' ? 'selected' : '' %>>Media</option>
          <option value="bassa" <%= filters.priority === 'bassa' ? 'selected' : '' %>>Bassa</option>
        </select>
      </div>
    </div>
    <button type="submit" class="btn btn-primary mt-2">
      <i class="fas fa-filter"></i> Filtra
    </button>
  </form>

  <div class="table-container">
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Veicolo</th>
          <th>Autista</th>
          <th>Descrizione</th>
          <th>Priorità</th>
          <th>Stato</th>
          <th>Data</th>
          <th>Azioni</th>
        </tr>
      </thead>
      <tbody>
        <% if (requests.length === 0) { %>
          <tr><td colspan="8" class="text-center text-secondary">Nessuna richiesta trovata</td></tr>
        <% } else { %>
          <% requests.forEach(req => { %>
            <tr>
              <td>#<%= req.id %></td>
              <td><%= req.targa %></td>
              <td><%= req.nome %> <%= req.cognome %></td>
              <td style="max-width: 300px;"><%= req.descrizione.substring(0, 100) %>...</td>
              <td>
                <% if (req.priorita === 'critica') { %>
                  <span class="badge badge-error">Critica</span>
                <% } else if (req.priorita === 'alta') { %>
                  <span class="badge badge-warning">Alta</span>
                <% } else if (req.priorita === 'media') { %>
                  <span class="badge badge-info">Media</span>
                <% } else { %>
                  <span class="badge badge-gray">Bassa</span>
                <% } %>
              </td>
              <td>
                <% if (req.stato === 'in_attesa') { %>
                  <span class="badge badge-warning">In Attesa</span>
                <% } else if (req.stato === 'in_lavorazione') { %>
                  <span class="badge badge-info">In Lavorazione</span>
                <% } else { %>
                  <span class="badge badge-success">Completata</span>
                <% } %>
              </td>
              <td><%= new Date(req.data_richiesta).toLocaleDateString('it-IT') %></td>
              <td>
                <a href="/admin/maintenance/<%= req.id %>" class="btn-icon" title="Dettagli">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>
